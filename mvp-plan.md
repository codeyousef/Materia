# KreeKt ‚Äî MVP STATUS ‚úÖ

**Targets:** Web (WebGPU), Desktop (Vulkan), Mobile (Android Vulkan, iOS/macOS via MoltenVK)  
**Goal:** Shortest path from *discover ‚Üí run ‚Üí customize ‚Üí share*, with a single Kotlin‚Äëfirst API across all KMP
targets.

---

## üìã Remaining Work Snapshot

1. **GPU layer unification** ‚Äì replace the placeholder `:kreekt-gpu` expect/actuals with delegates to the existing
   Vulkan/WebGPU implementations (`io.kreekt.renderer.gpu.*`).
   - Shader modules and command buffer/queue submission now bridge through the renderer layer.
   - **Remaining**: surface/swapchain integration, render-pass encoding, pipeline creation, textures/bind groups.
2. **Triangle smoke via real backend** ‚Äì boot the example through `RendererFactory`/`RenderSurface` so the Vulkan/WebGPU
   renderers drive the frame instead of the stub submission.
3. **Materials & bindings** ‚Äì hook `UnlitColorMaterial` / `UnlitPointsMaterial` into backend bind-group & pipeline
   layouts; validate geometry stride/offset handling. (Blocked on Vulkan bind group/texture plumbing.)
4. **Instanced points + galaxy/force demos** ‚Äì build the point-cloud pipeline, baked data loaders, and scene wiring for
   Embedding Galaxy and Force Graph.
5. **Target bootstraps & docs/tests** ‚Äì flesh out per-platform launchers, math/scene tests, and MVP documentation once
   the rendering path is stable.

Keep this list in sync as tasks complete; the detailed checklist below mirrors these priorities.

---

## üöÄ First 10 Minutes (Quickstart)

> The commands below are the **intended** Gradle tasks Codex should generate.  
> Running any one should put ‚Äúfirst pixels‚Äù on screen.

### 1) Web (wasmJs + WebGPU)

```bash
./gradlew :examples:triangle:wasmJsBrowserRun
./gradlew :examples:embedding-galaxy:wasmJsBrowserRun
./gradlew :examples:force-graph:wasmJsBrowserRun
````

* Opens a dev server; hot reload on save.
* Requires a WebGPU‚Äëcapable browser.

### 2) Desktop (JVM Vulkan; Windows/Linux/macOS)

```bash
./gradlew :examples:triangle:run
./gradlew :examples:embedding-galaxy:run
./gradlew :examples:force-graph:run
```

* GLFW window; vsync on; resizes properly.

### 3) Android (Vulkan)

```bash
./gradlew :examples:triangle:installDebug
adb shell am start -n com.kreekt.examples.triangle/.MainActivity
```

* Similar tasks for other examples.

### 4) iOS / macOS (MoltenVK)

* iOS: Xcode scheme generated by Gradle (Simulator OK).
* macOS: Native launcher targeting MoltenVK.

**If any of these do not show ‚Äúfirst pixels‚Äù in <5 minutes, fix before adding features.**

---

## üß≠ Target Matrix (one API, per‚Äëtarget backends)

| Target                              | Backend  | Shader Path         | Surface                      |
|-------------------------------------|----------|---------------------|------------------------------|
| wasmJs (Browser)                    | WebGPU   | WGSL                | HTMLCanvas + `navigator.gpu` |
| jvm / linuxX64 / mingwX64 (Desktop) | Vulkan   | WGSL ‚Üí SPIR‚ÄëV       | GLFW + Vulkan swapchain      |
| macOS / iOS                         | MoltenVK | WGSL ‚Üí SPIR‚ÄëV ‚Üí MVK | CAMetalLayer via MoltenVK    |
| Android                             | Vulkan   | WGSL ‚Üí SPIR‚ÄëV       | SurfaceView + Vulkan         |

> **Rule:** Public API mirrors **WebGPU** semantics; Vulkan/MVK adapt underneath. **Single source of truth = WGSL**
> shaders.

---

## üß± Project Layout (Codex should scaffold)

```
:kreekt-gpu/          # expect/actual GPU layer (WebGPU semantics)
:kreekt-engine/       # scene graph, geometry, materials, instancing, renderer
:examples:triangle/
:examples:embedding-galaxy/
:examples:force-graph/
resources/shaders/*.wgsl
```

---

## üìê API & DX Principles (must hold for every public API)

* **Kotlin‚Äëfirst**: idiomatic naming, default params, named args, extension functions, KDoc.
* **Zero‚Äëcost**: `@JvmInline` value classes, `inline` funcs, reified generics, no hidden allocs in hot paths.
* **KMP‚Äëfirst**: one public API via `expect/actual`.
* **Small DSLs where it helps** (scene/pipeline), plain functions for tight loops.
* **Strong types** (vectors/matrices/colors); no stringly configs.
* **Structured concurrency**: coroutines for IO/asset upload only; never inside per‚Äëframe loops.
* **Escape hatches**: low‚Äëlevel buffer/descriptor access for perf work.

**Kotlin features to use deliberately**

* Context receivers for render‚Äëscoped ops:
  `context(RenderPass) inline fun Mesh.draw(instances: Int = 1)`
* Contracts on builders to prevent lambda leakage (`callsInPlace`).
* Primitive arrays for vertex/instance data; avoid boxing/collections in hot path.
* Persistent mapping (Vulkan), ring buffers for per‚Äëframe uniforms; bind‚Äëgroup/descriptor caches.

---

## ‚úÖ MVP Feature Checklist

### 1) GPU/Core Abstractions (commonMain)

* [ ] `GpuInstance`, `GpuAdapter`, `GpuDevice`, `GpuQueue`
* [ ] `GpuSurface` (configure, present, resize)
* [ ] Resources: `GpuBuffer`, `GpuTexture`, `GpuTextureView`, `GpuSampler`
    * [x] JVM sampler creation delegates to Vulkan (`vkCreateSampler`)
    * [x] JVM texture allocation binds Vulkan `VkImage`/memory and exposes image views
* [ ] Shaders & pipelines

    * [x] `GpuShaderModule` (WGSL; compile to SPIR‚ÄëV for Vulkan/MVK)
    * [x] `GpuBindGroupLayout` / `GpuBindGroup` (‚âà Vulkan descriptor sets)
* [x] `GpuRenderPipeline`, `GpuComputePipeline`
* [ ] Command encoding & submit

* [x] `GpuCommandEncoder` ‚Üí `beginRenderPass`/`beginComputePass` ‚Üí `finish`
* [x] `GpuCommandBuffer`, `GpuQueue.submit()`
* [x] Minimal hidden sync (fences/events on Vulkan/MVK)
* [ ] Consolidate legacy `io.kreekt.renderer.gpu.*` with `:kreekt-gpu` expect/actuals (typealiases or wrappers)
* [ ] Delegate `:kreekt-gpu` Vulkan/WebGPU implementations to `VulkanRenderer` / `WebGPURenderer` command paths
* [x] Provide shared swapchain/surface factory bridging `RenderSurface` ‚Üí `GpuSurface`

### 2) Rendering Engine (common)

* [x] Scene graph: `Node` (TRS, hierarchy, dirty flags), `Scene.update(dt)`
* [ ] Camera: `PerspectiveCamera` + **OrbitController**
* [ ] Geometry: interleaved VBO + IBO (pos, normal?, uv?)
* [ ] Drawables

    * [ ] `Mesh(geometry, material)`
    * [ ] **InstancedPoints** (per‚Äëinstance: position, color, size, extra0)
* [ ] Materials

    * [x] `UnlitColorMaterial`
    * [x] `UnlitPointsMaterial` (VS quad expansion; distance attenuation)
* [x] Pipeline state helpers: depth test/write, culling, alpha/additive blending
* [x] Optional post: **FXAA** (toggle)
* [ ] Material bindings ‚Üí shader pipeline layout (bridging to backend descriptor sets)
* [ ] Integrate engine drawables with real renderer submission (Geometry ‚Üí vertex/index buffers)

### 3) Math & Utils

* [x] `Vec2/3/4`, `Mat4`, `Quat`, `Color` ‚Äî value classes, inline ops
* [x] `Spline` (Catmull‚ÄìRom) for camera rails + easing functions
* [x] AABB & frustum (CPU) for coarse culling
* [ ] Frame‚Äëlocal **Arena** + **uniform ring buffers**

### 4) IO & Data

* [x] `loadJson(urlOrPath)` (fetch on web; file on JVM/native; assets on Android/iOS)
* [ ] Data models

    * [x] `EmbeddingData(dims: Int, vectors: FloatArray, labels?: List<String>, clusters?: IntArray)`
    * [x] `GraphData(nodes: List<NodeInfo>, edges: List<EdgeInfo>, weights?: FloatArray)`
* [x] Synthetic generators (clustered embeddings; small graph)
* [x] (JVM/Native) `saveJson(path, obj)` for baked layouts

### 5) Examples (adoption funnel)

* [ ] **Triangle** (smoke): clear + draw + resize on every target
    * [x] Boot via `RendererFactory` / `SurfaceFactory` (Vulkan/WebGPU actual implementations)
    * [x] Replace placeholder GPU submission with backend-rendered frame
* [ ] **Embedding Galaxy** (wow)

    * [ ] 20k InstancedPoints; 5‚Äì6 clusters; camera spline
    * [ ] ‚ÄúQuery shockwave‚Äù every 4s (similarity threshold ‚Üí size/emissive tween)
    * [ ] FXAA toggle
    * [ ] Perf floor: desktop ~60 FPS @1080p; browser ‚â•45 FPS; mobile ‚â•30 FPS (defaults)
* [ ] **Force Graph** (credibility)

    * [ ] 2‚Äì5k nodes / 6‚Äì10k edges
    * [ ] **Bake layout** on JVM/native ‚Üí JSON; all targets load
    * [ ] Toggle **TF‚ÄëIDF ‚Üî Semantic** (edge thickness/opacity tween + slight node nudge)

### 6) Per‚ÄëTarget Bootstraps

* [ ] wasmJs: canvas + WebGPU init, RAF loop, pointer events
* [ ] JVM/native: GLFW window, Vulkan instance/device/swapchain, vsync, resize
* [ ] macOS/iOS: CAMetalLayer via MoltenVK; robust swapchain re‚Äëcreate
* [ ] Android: Activity + SurfaceView; lifecycle‚Äësafe teardown/recreate

### 7) Shader Toolchain (single-source WGSL)

* [x] Store shaders in `resources/shaders/*.wgsl`
* [x] Web: use WGSL directly
* [x] Vulkan/MVK: WGSL ‚Üí SPIR-V (Tint/Naga) at build or first run
* [x] Minimal set

    * [x] `unlit_points.vert.wgsl`, `unlit_points.frag.wgsl`
    * [x] `unlit_color.vert.wgsl`,  `unlit_color.frag.wgsl`
    * [x] `fullscreen_fxaa.vert.wgsl`, `fullscreen_fxaa.frag.wgsl` (optional)

### 8) Tooling, Build & CI

* [ ] Enable KMP targets: wasmJs, jvm, linuxX64, mingwX64, macosArm64/x64, iosArm64/simulator, android
* [ ] Gradle tasks per example

    * [ ] Web: `:examples:*:wasmJsBrowserRun`
    * [ ] Desktop: `:examples:*:run` (JVM) + native launchers
    * [ ] Android: `installDebug`
    * [ ] iOS: Xcode scheme
* [ ] CI matrix

    * [ ] Build + tests on JVM + LinuxX64 + wasmJs
    * [ ] Headless triangle smoke where feasible

### 9) Tests (minimum)

* [x] Math: matrix√óvector, quat‚Üímatrix, `lookAt` correctness
* [x] Scene: world-transform propagation & dirty-flag invalidation
* [ ] GPU: attribute stride/offset validation for **InstancedPoints** (WebGPU & Vulkan)
* [ ] Layout: force layout determinism on tiny graph (seeded)

> Pending follow-up: rerun `./gradlew :kreekt-engine:jvmTest` once the SSL trust store issue is resolved so the new
> math/scene tests can execute on CI.

### 10) Docs (minimum)

* [ ] Root **README**: supported targets, drivers, per‚Äëtarget quickstart
* [ ] **API_STYLE.md**: idioms, nullability, defaults, context receivers, errors
* [ ] **PERF_NOTES.md**: persistent maps, ring buffers, descriptor/pipeline caches
* [ ] **MVP_STATUS.md** (this file) with checkboxes
* [ ] Example READMEs: expected FPS, config knobs, keybinds

### 11) Non‚ÄëGoals for MVP

* PBR/IBL, shadows, skeletal animation, HDR pipeline
* Complex render graph, async streaming, mesh shaders
* Editor/inspector UI, universal hot‚Äëreload

---

## üéØ Adoption Gates (ship only when all pass)

* [ ] **Hello Triangle in <5 minutes** on at least one target per platform family (web/desktop/mobile).
* [ ] **Embedding Galaxy** runs smoothly with defaults on desktop; acceptable on web/mobile.
* [ ] **Force Graph** toggle is visually obvious & stutter‚Äëfree.
* [ ] APIs feel **Kotlin‚Äënative** (named args, defaults, extensions, KDoc).
* [ ] Users can change one number (e.g., `count = 20000 ‚Üí 8000`) and instantly see the effect.

---

## üß© Hello Triangle (reference snippet)

```kotlin
val device = Gpu.pickBestDevice()
val surface = device.createSurface(window)

val pipeline = device.createRenderPipeline(RenderPipelineDesc {
    vertex = shader(loadText("shaders/unlit_color.vert.wgsl"))
    fragment = shader(loadText("shaders/unlit_color.frag.wgsl"))
    topology = Topology.Triangles
    colorFormat = surface.preferredFormat
})

fun frame() {
    val encoder = device.createCommandEncoder()
    val view = surface.currentTexture()
    encoder.beginRenderPass(RenderPassDesc(view)).use { pass ->
        pass.setPipeline(pipeline)
        pass.setVertexBuffer(0, triangleBuffer)
        pass.draw(3)
    }
    device.queue.submit(encoder.finish())
}
```

---

## üõ†Ô∏è Config Knobs (examples)

* `EmbeddingGalaxy.Config(count = 20000, clusters = 6, quality = "balanced")`
* `ForceGraph.Config(nodes = 3000, edges = 8000, mode = Mode.Semantic)`

---

## üî¨ Performance Notes (TL;DR)

* Keep **uniform buffers** in ring buffers; avoid per‚Äëframe mallocs.
* **Persistently map** Vulkan staging buffers; batch writes.
* Cache **bind groups/descriptor sets** and **pipelines**; warm up at scene load.
* Use **primitive arrays** for vertex/instance data; avoid boxing/collections in hot paths.
* Prefer **additive blending + unlit** for large point clouds; keep it cheap.

---

*If a checklist item is ambiguous, prioritize: time‚Äëto‚Äëfirst‚Äëpixels, smoothness, and Kotlin DX.*
